<!DOCTYPE html>
<html>
<head>
  <title>Ramudu‚ÄìSita Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <style>
    body{margin:0;background:#000;color:#fff;font-family:system-ui,Arial;display:flex;justify-content:center;}
    .app{width:100%;max-width:420px;padding:16px;}
    .card{background:#111;border-radius:14px;padding:16px;margin-bottom:14px;}
    input,button{width:100%;padding:14px;font-size:16px;border-radius:12px;border:none;margin-top:8px;}
    button{background:#ff9800;color:#000;font-weight:600;}
    button.secondary{background:#333;color:#fff;}
    button.danger{background:#c62828;color:#fff;}
    button:disabled{opacity:.4}
    #game{display:none;}
    .status{text-align:center;color:#aaa;}
    .role{text-align:center;font-size:20px;font-weight:700;}
    .timer{text-align:center;color:#ff5252;font-size:18px;}
  </style>
</head>

<body>
<div class="app">

<h2 style="text-align:center">üéÆ Ramudu‚ÄìSita Game</h2>

<div class="card">
  <input id="name" placeholder="Enter your name">
  <button onclick="joinGame()">Join Game</button>
</div>

<div id="game">

  <div class="card">
    <div class="status" id="status">Waiting for players‚Ä¶</div>
    <div class="role" id="myrole"></div>
    <div class="timer" id="timer"></div>

    <button id="startBtn" onclick="startGame()" disabled>Start Game (Host)</button>
    <button id="nextBtn" class="secondary" onclick="nextGame()" style="display:none">Next Game</button>
    <button id="resetAllBtn" class="danger" onclick="resetAll()" style="display:none">Reset ALL (Host)</button>

    <button id="readyBtn" class="secondary" onclick="setReady()">READY</button>
  </div>

  <div class="card" id="ramaPanel" style="display:none">
    <h3>Select Sita</h3>
    <div id="playerList"></div>
  </div>

  <div class="card">
    <div id="score"></div>
  </div>

</div>
</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyAgW8uCRYRt9vQR59tcZKPZ5frkIdUtzIA",
  authDomain:"ramudu-game.firebaseapp.com",
  databaseURL:"https://ramudu-game-default-rtdb.firebaseio.com",
  projectId:"ramudu-game",
  storageBucket:"ramudu-game.firebasestorage.app",
  messagingSenderId:"1024983133761",
  appId:"1:1024983133761:web:bd97cd6a42b09daad260c0"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();

let uid="",timerInt=null,selectionLocked=false;

const roleOrder=[
 "rama","sita",
 "lakshmana","hanuman","baratha",
 "satrugunudu","jambavanta","sugrivudu","vali"
];

const roleScore={
 rama:0,sita:0,
 lakshmana:900,hanuman:800,baratha:700,
 satrugunudu:600,jambavanta:500,sugrivudu:400,vali:300
};

auth.signInAnonymously().then(r=>uid=r.user.uid);

/* üîÄ SHUFFLE FUNCTION */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function joinGame(){
  const name=document.getElementById("name").value.trim();
  if(!name) return alert("Enter name");

  const ref=db.ref("players/"+uid);
  ref.set({name,role:"",score:0,ready:false});
  ref.onDisconnect().remove();

  document.getElementById("game").style.display="block";
  listen();
}

function setReady(){
  db.ref("players/"+uid+"/ready").set(true);
}

function startGame(){
  db.ref("host").once("value",h=>{
    if(h.val()!==uid) return;

    db.ref("players").once("value",ps=>{
      let players=ps.val();
      let ids=Object.keys(players||{});
      if(ids.length<4) return alert("Min 4 players");

      const allReady=ids.every(id=>players[id].ready||id===uid);
      if(!allReady) return alert("All players not ready");

      selectionLocked=false;
      document.getElementById("ramaPanel").style.display="none";

      ids = shuffle(ids); // üî• THIS IS THE FIX

      ids.forEach((id,i)=>{
        const role=roleOrder[i]||"vali";
        db.ref("players/"+id).update({role,ready:false});
      });

      db.ref("status").set("Roles assigned. Rama choose Sita!");
      startTimer();
    });
  });
}

function startTimer(){
  let t=20;
  db.ref("timer").set(t);
  timerInt=setInterval(()=>{
    t--; db.ref("timer").set(t);
    if(t<=0){
      clearInterval(timerInt);
      selectionLocked=true;
      db.ref("ramaChoice").set("TIMEOUT");
    }
  },1000);
}

function selectSita(id){
  if(selectionLocked) return;
  selectionLocked=true;
  clearInterval(timerInt);
  db.ref("timer").remove();
  db.ref("ramaChoice").set(id);
}

function nextGame(){
  db.ref("host").once("value",h=>{
    if(h.val()!==uid) return;

    db.ref("ramaChoice").remove();
    db.ref("timer").remove();
    db.ref("status").set("Next round. Players click READY");

    db.ref("players").once("value",ps=>{
      const p=ps.val();
      for(let id in p){
        db.ref("players/"+id).update({role:"",ready:false});
      }
    });

    document.getElementById("nextBtn").style.display="none";
  });
}

function resetAll(){
  db.ref("host").once("value",h=>{
    if(h.val()!==uid) return;
    db.ref().remove(); location.reload();
  });
}

function listen(){
  db.ref("players").on("value",snap=>{
    const p=snap.val(); if(!p||!p[uid])return;
    const ids=Object.keys(p), hostUid=ids[0];
    db.ref("host").set(hostUid);

    if(hostUid===uid){
      db.ref().onDisconnect().remove();
    }

    document.getElementById("myrole").innerText =
      p[uid].role ? "You are: "+p[uid].role.toUpperCase() : "";

    let txt="";
    ids.forEach(id=>txt+=`${p[id].name} ${p[id].ready?"‚úÖ":""} : ${p[id].score}<br>`);
    document.getElementById("score").innerHTML=txt;

    if(uid===hostUid){
      document.getElementById("readyBtn").style.display="none";
      document.getElementById("resetAllBtn").style.display="block";
      const allReady=ids.every(id=>p[id].ready||id===uid);
      document.getElementById("startBtn").disabled=!allReady;
    }else{
      document.getElementById("readyBtn").style.display="block";
      document.getElementById("readyBtn").disabled=p[uid].ready;
      document.getElementById("startBtn").style.display="none";
      document.getElementById("resetAllBtn").style.display="none";
    }

    if(p[uid].role==="rama"&&!selectionLocked){
      const list=document.getElementById("playerList");
      list.innerHTML="";
      document.getElementById("ramaPanel").style.display="block";
      ids.forEach(id=>{
        if(id===uid)return;
        const b=document.createElement("button");
        b.innerText=p[id].name;
        b.onclick=()=>selectSita(id);
        list.appendChild(b);
      });
    }else{
      document.getElementById("ramaPanel").style.display="none";
    }
  });

  db.ref("ramaChoice").on("value",snap=>{
    const choice=snap.val(); if(!choice)return;
    db.ref("players").once("value",ps=>{
      const p=ps.val();
      const correct=choice!=="TIMEOUT"&&p[choice].role==="sita";
      for(let id in p){
        let add=0;
        if(p[id].role==="rama") add=correct?1000:0;
        else if(p[id].role==="sita") add=correct?0:1000;
        else add=roleScore[p[id].role];
        db.ref("players/"+id+"/score").set((p[id].score||0)+add);
      }
      db.ref("status").set(correct?"üèπ Rama found Sita!":"üå∏ Rama failed!");
      if(uid===Object.keys(p)[0]) document.getElementById("nextBtn").style.display="block";
    });
  });
}
</script>

</body>
</html>
