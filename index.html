<!DOCTYPE html>
<html>
<head>
  <title>Ramudu‚ÄìSita Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <style>
    body{
      background:#000;color:#fff;font-family:system-ui;
      padding:16px;display:flex;justify-content:center;
    }
    .app{max-width:420px;width:100%}
    input,button{
      width:100%;padding:14px;margin:6px 0;
      font-size:16px;border-radius:10px;border:none;
    }
    button{background:#ff9800;color:#000;font-weight:600}
    button:disabled{background:#555;color:#222}
    .secondary{background:#333;color:#fff}
    .danger{background:#c62828;color:#fff}
    .card{background:#111;padding:14px;border-radius:14px;margin-bottom:12px}
    #game{display:none}
    #ramaPanel{display:none}
    .timer{color:#ff5252;text-align:center;font-size:18px}
  </style>
</head>

<body>
<div class="app">

<h2 style="text-align:center">üéÆ Ramudu‚ÄìSita</h2>

<div class="card">
  <input id="name" placeholder="Enter your name">
  <button onclick="joinGame()">Join Game</button>
</div>

<div id="game">
  <div class="card">
    <div id="status">Waiting for players‚Ä¶</div>
    <div id="myrole"></div>
    <div class="timer" id="timer"></div>

    <button id="startBtn" onclick="startGame()" style="display:none">Start Game</button>
    <button class="secondary" onclick="resetAll()">Reset All</button>
  </div>

  <div class="card" id="ramaPanel">
    <h3>Select Sita (ONE TIME)</h3>
    <div id="playerList"></div>
  </div>

  <div class="card" id="score"></div>

  <button class="danger" onclick="leaveGame()">Leave Game</button>
</div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAgW8uCRYRt9vQR59tcZKPZ5frkIdUtzIA",
  authDomain: "ramudu-game.firebaseapp.com",
  databaseURL: "https://ramudu-game-default-rtdb.firebaseio.com",
  projectId: "ramudu-game",
  storageBucket: "ramudu-game.firebasestorage.app",
  messagingSenderId: "1024983133761",
  appId: "1:1024983133761:web:bd97cd6a42b09daad260c0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let uid="", timerInterval=null;

/* Role order */
const roles = [
  {name:"rama",score:0},
  {name:"sita",score:0},
  {name:"lakshmana",score:900},
  {name:"hanuman",score:800},
  {name:"baratha",score:700},
  {name:"satrugunudu",score:600},
  {name:"jambavanta",score:500},
  {name:"sugrivudu",score:400},
  {name:"vali",score:300}
];

auth.signInAnonymously().then(r=>uid=r.user.uid);

function shuffle(a){ return [...a].sort(()=>Math.random()-0.5); }

/* Join */
function joinGame(){
  const name=document.getElementById("name").value.trim();
  if(!name) return alert("Enter name");

  db.ref("players/"+uid).set({
    name, role:"", score:0, roleRewarded:false
  });

  db.ref("hostId").transaction(v=>v||uid);
  document.getElementById("game").style.display="block";
  listen();
}

/* Start Game (HOST ONLY) */
function startGame(){
  db.ref("hostId").once("value",h=>{
    if(h.val()!==uid) return alert("Only host can start");

    db.ref("players").once("value",snap=>{
      const players=snap.val();
      const ids=shuffle(Object.keys(players||{}));
      if(ids.length<4) return alert("Minimum 4 players");

      ids.forEach((id,i)=>{
        const role=roles[i]||roles[roles.length-1];
        db.ref("players/"+id).update({
          role:role.name,
          roleRewarded:false
        });
      });

      // üîí reset round locks
      db.ref("roundLocked").set(false);
      db.ref("roundScored").set(false);

      db.ref("ramaChoice").remove();
      db.ref("timerEnd").set(Date.now()+20000);
      db.ref("status").set("Roles assigned. Rama, choose Sita!");
    });
  });
}

/* Rama selects ‚Äî ONE TIME ONLY */
function selectSita(id){
  db.ref("roundLocked").transaction(v=>{
    if(v===true) return;      // already locked
    db.ref("ramaChoice").set(id);
    return true;              // lock round
  });
}

/* Leave */
function leaveGame(){
  db.ref("players/"+uid).remove();
  location.reload();
}

/* Reset */
function resetAll(){
  if(confirm("Reset all players?")){
    db.ref().remove();
    location.reload();
  }
}

/* LISTENERS */
function listen(){

  /* Host button */
  db.ref("hostId").on("value",h=>{
    document.getElementById("startBtn").style.display =
      h.val()===uid?"block":"none";
  });

  /* Players */
  db.ref("players").on("value",snap=>{
    const p=snap.val();
    if(!p||!p[uid])return;

    const myRole=p[uid].role;
    document.getElementById("myrole").innerText =
      myRole?"You are: "+myRole.toUpperCase():"";

    if(myRole==="rama") showRamaPanel(p);
    else document.getElementById("ramaPanel").style.display="none";

    let txt="üèÜ Total Scores<br>";
    for(let id in p){
      txt+=`${p[id].name} : ${p[id].score}<br>`;
    }
    document.getElementById("score").innerHTML=txt;
  });

  /* Timer */
  db.ref("timerEnd").on("value",snap=>{
    clearInterval(timerInterval);
    if(!snap.val()){document.getElementById("timer").innerText="";return;}

    timerInterval=setInterval(()=>{
      const left=Math.max(0,Math.ceil((snap.val()-Date.now())/1000));
      document.getElementById("timer").innerText=
        left>0?"‚è± "+left+"s":"";

      if(left<=0){
        clearInterval(timerInterval);
        selectSita("TIMEOUT");
      }
    },500);
  });

  /* SCORING ‚Äî ONLY ONCE */
  db.ref("ramaChoice").on("value",snap=>{
    const choice=snap.val();
    if(!choice) return;

    db.ref("roundScored").transaction(done=>{
      if(done===true) return;   // already scored
      return true;
    },(err,committed)=>{
      if(!committed) return;

      db.ref("players").once("value",ps=>{
        const players=ps.val();
        const correct = choice!=="TIMEOUT" && players[choice].role==="sita";

        for(let id in players){
          const p=players[id];
          let add=0;

          if(p.role==="rama") add=correct?1000:0;
          else if(p.role==="sita") add=correct?0:1000;
          else if(!p.roleRewarded){
            const r=roles.find(x=>x.name===p.role);
            add=r?r.score:0;
            db.ref("players/"+id+"/roleRewarded").set(true);
          }

          if(add>0){
            db.ref("players/"+id+"/score")
              .transaction(s=>(s||0)+add);
          }
        }

        db.ref("status").set(
          correct?"üèπ Rama found Sita!":"üå∏ Rama failed!"
        );

        db.ref("timerEnd").remove();
      });
    });
  });

  db.ref("status").on("value",s=>{
    if(s.val()) document.getElementById("status").innerText=s.val();
  });
}

/* Rama UI */
function showRamaPanel(players){
  const panel=document.getElementById("ramaPanel");
  const list=document.getElementById("playerList");
  panel.style.display="block";
  list.innerHTML="";

  db.ref("roundLocked").once("value",lock=>{
    const disabled = lock.val()===true;

    for(let id in players){
      if(id===uid) continue;
      const b=document.createElement("button");
      b.innerText=players[id].name;
      b.disabled = disabled;
      b.onclick=()=>selectSita(id);
      list.appendChild(b);
    }
  });
}
</script>

</body>
</html>
