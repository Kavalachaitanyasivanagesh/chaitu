<!DOCTYPE html>
<html>
<head>
  <title>Ramuduâ€“Sita Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <style>
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui, Arial;
      display:flex;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width:420px;
      padding:16px;
    }
    h1{text-align:center;margin:10px 0 20px;}
    .card{
      background:#111;
      border-radius:14px;
      padding:16px;
      margin-bottom:14px;
      box-shadow:0 0 0 1px #222;
    }
    input,button{
      width:100%;
      padding:14px;
      font-size:16px;
      border-radius:12px;
      border:none;
      margin-top:8px;
    }
    button{background:#ff9800;color:#000;font-weight:600;}
    button.secondary{background:#333;color:#fff;}
    button.danger{background:#c62828;color:#fff;}
    button:disabled{opacity:.4}
    #game{display:none;}
    .status{text-align:center;color:#aaa;}
    .role{text-align:center;font-size:20px;font-weight:700;}
    .timer{text-align:center;color:#ff5252;font-size:18px;}
    .player-list button{margin-top:6px;}
  </style>
</head>

<body>
<div class="app">

<h1>ðŸŽ® Ramuduâ€“Sita Game</h1>

<div class="card">
  <input id="name" placeholder="Enter your name">
  <button onclick="joinGame()">Join Game</button>
</div>

<div id="game">

  <div class="card">
    <div class="status" id="status">Waiting for playersâ€¦</div>
    <div class="role" id="myrole"></div>
    <div class="timer" id="timer"></div>

    <!-- Host controls -->
    <button id="startBtn" onclick="startGame()" disabled>Start Game (Host)</button>
    <button id="nextBtn" class="secondary" onclick="nextGame()" style="display:none">
      Next Game
    </button>

    <!-- Ready for players -->
    <button id="readyBtn" class="secondary" onclick="setReady()">READY</button>
  </div>

  <div class="card" id="ramaPanel" style="display:none">
    <h3>Select Sita</h3>
    <div id="playerList" class="player-list"></div>
  </div>

  <div class="card">
    <div id="score"></div>
  </div>

  <button class="danger" onclick="leaveGame()">Leave Game</button>

</div>
</div>

<script>
/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyAgW8uCRYRt9vQR59tcZKPZ5frkIdUtzIA",
  authDomain: "ramudu-game.firebaseapp.com",
  databaseURL: "https://ramudu-game-default-rtdb.firebaseio.com",
  projectId: "ramudu-game",
  storageBucket: "ramudu-game.firebasestorage.app",
  messagingSenderId: "1024983133761",
  appId: "1:1024983133761:web:bd97cd6a42b09daad260c0"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const auth = firebase.auth();

let uid="", timerInt=null, selectionLocked=false;

/* Role order & scores */
const roleOrder=[
 {name:"rama",score:0},
 {name:"sita",score:0},
 {name:"lakshmana",score:900},
 {name:"hanuman",score:800},
 {name:"baratha",score:700},
 {name:"satrugunudu",score:600},
 {name:"jambavanta",score:500},
 {name:"sugrivudu",score:400},
 {name:"vali",score:300}
];

auth.signInAnonymously().then(r=>uid=r.user.uid);

/* Join game */
function joinGame(){
  const name=document.getElementById("name").value.trim();
  if(!name) return alert("Enter name");

  db.ref("players/"+uid).set({
    name,
    role:"",
    score:0,
    ready:false
  });

  document.getElementById("game").style.display="block";
  listen();
}

/* Ready */
function setReady(){
  db.ref("players/"+uid+"/ready").set(true);
  document.getElementById("readyBtn").disabled=true;
}

/* Start game (host only) */
function startGame(){
  db.ref("host").once("value",h=>{
    if(h.val()!==uid) return alert("Only host can start");

    db.ref("gameStarted").once("value",g=>{
      if(g.val()) return;

      db.ref("players").once("value",ps=>{
        const p=ps.val();
        const ids=Object.keys(p||{});
        if(ids.length<4) return alert("Minimum 4 players");

        const allReady=ids.every(id=>p[id].ready || id===uid);
        if(!allReady) return alert("All players not ready");

        db.ref("gameStarted").set(true);
        selectionLocked=false;

        ids.forEach((id,i)=>{
          const r=roleOrder[i]||roleOrder[roleOrder.length-1];
          db.ref("players/"+id).update({
            role:r.name,
            ready:false
          });
        });

        db.ref("status").set("Roles assigned. Rama, choose Sita!");
        startTimer();
      });
    });
  });
}

/* Rama timer */
function startTimer(){
  let t=20;
  db.ref("timer").set(t);
  timerInt=setInterval(()=>{
    t--;
    db.ref("timer").set(t);
    if(t<=0){
      clearInterval(timerInt);
      lockSelection();
      db.ref("ramaChoice").set("TIMEOUT");
    }
  },1000);
}

/* Rama selects */
function selectSita(id){
  if(selectionLocked) return;
  lockSelection();
  clearInterval(timerInt);
  db.ref("timer").remove();
  db.ref("ramaChoice").set(id);
}

function lockSelection(){
  selectionLocked=true;
  document.getElementById("ramaPanel").style.display="none";
}

/* Next Game (host only) */
function nextGame(){
  db.ref("host").once("value",h=>{
    if(h.val()!==uid) return alert("Only host can start next game");

    db.ref("ramaChoice").remove();
    db.ref("timer").remove();
    db.ref("gameStarted").remove();
    db.ref("status").set("Next round. Players click READY");

    db.ref("players").once("value",ps=>{
      const players=ps.val();
      for(let id in players){
        db.ref("players/"+id).update({
          role:"",
          ready:false,
          score:0
        });
      }
    });

    document.getElementById("readyBtn").disabled=false;
    document.getElementById("nextBtn").style.display="none";
  });
}

/* Leave */
function leaveGame(){
  db.ref("players/"+uid).remove();
  location.reload();
}

/* Listen */
function listen(){
  db.ref("players").on("value",snap=>{
    const p=snap.val();
    if(!p||!p[uid])return;

    const ids=Object.keys(p);

    /* Host = first player */
    db.ref("host").set(ids[0]);

    document.getElementById("myrole").innerText =
      p[uid].role ? "You are: "+p[uid].role.toUpperCase() : "";

    let txt="";
    ids.forEach(id=>{
      txt+=`${p[id].name} ${p[id].ready?"âœ…":""} : ${p[id].score}<br>`;
    });
    document.getElementById("score").innerHTML=txt;

    /* Start button enable for host */
    if(ids[0]===uid){
      const allReady=ids.every(id=>p[id].ready || id===uid);
      document.getElementById("startBtn").disabled=!allReady;
    }else{
      document.getElementById("startBtn").style.display="none";
    }

    /* Rama panel */
    if(p[uid].role==="rama" && !selectionLocked){
      const list=document.getElementById("playerList");
      list.innerHTML="";
      document.getElementById("ramaPanel").style.display="block";

      ids.forEach(id=>{
        if(id===uid) return;
        const b=document.createElement("button");
        b.innerText=p[id].name;
        b.onclick=()=>selectSita(id);
        list.appendChild(b);
      });
    }
  });

  db.ref("timer").on("value",s=>{
    document.getElementById("timer").innerText =
      s.val()!=null?`â± ${s.val()}s left`:"";
  });

  db.ref("ramaChoice").on("value",snap=>{
    const choice=snap.val();
    if(!choice)return;

    db.ref("players").once("value",ps=>{
      const players=ps.val();
      const correct=choice!=="TIMEOUT" && players[choice].role==="sita";

      for(let id in players){
        let role=players[id].role,score=0;
        if(role==="rama") score=correct?1000:0;
        else if(role==="sita") score=correct?0:1000;
        else{
          const r=roleOrder.find(x=>x.name===role);
          score=r?r.score:0;
        }
        db.ref("players/"+id+"/score").set(score);
      }

      db.ref("status").set(correct?"ðŸ¹ Rama found Sita!":"ðŸŒ¸ Rama failed!");
      db.ref("gameStarted").remove();

      /* Show Next Game button for host */
      db.ref("host").once("value",h=>{
        if(h.val()===uid){
          document.getElementById("nextBtn").style.display="block";
        }
      });
    });
  });

  db.ref("status").on("value",s=>{
    if(s.val()) document.getElementById("status").innerText=s.val();
  });
}
</script>

</body>
</html>
